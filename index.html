<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WvW Commander Intel V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f1115; color: #cfd3d8; }
        
        /* Categories & Chips */
        .tag-base { font-size: 0.7rem; font-weight: 700; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; white-space: nowrap; }
        .tag-field { background: #1e293b; color: #94a3b8; border: 1px solid #334155; }
        
        /* Specific Effect Colors */
        .ef-stab { background: #0ea5e9; color: #000; box-shadow: 0 0 8px rgba(14, 165, 233, 0.4); } /* Stability - Cyan */
        .ef-water { background: #3b82f6; color: #fff; } /* Water Field - Blue */
        .ef-fire { background: #ef4444; color: #fff; } /* Fire Field - Red */
        .ef-blast { background: #f97316; color: #fff; } /* Blast - Orange */
        .ef-cleanse { background: #eab308; color: #000; } /* Cleanse - Yellow */
        .ef-strip { background: #a855f7; color: #fff; } /* Strip - Purple */
        .ef-pull { background: #ec4899; color: #fff; } /* Pull - Pink */
        .ef-stealth { background: #64748b; color: #fff; } /* Stealth - Grey */

        .player-row { transition: background 0.2s; }
        .player-row:hover { background: #1f2937; }
        
        /* Loading Spinner */
        .loader { border: 3px solid #374151; border-top: 3px solid #10b981; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- COMMANDER DATABASE (The "Good Stuff") ---
        // We map specific SKILL IDs (not palette IDs) to metadata.
        const SKILL_META = {
            // --- GUARDIAN ---
            9081: { name: "\"Stand Your Ground!\"", type: "Utility", effect: "ef-stab", label: "STABILITY" },
            9036: { name: "Hallowed Ground", type: "Utility", effect: "ef-stab", label: "STAB (Field)" },
            9168: { name: "Wall of Reflection", type: "Utility", effect: "ef-reflect", label: "REFLECT" },
            44946: { name: "Mantra of Liberation", type: "Utility", effect: "ef-stab", label: "STAB (Mantra)" },
            
            // --- NECROMANCER ---
            10615: { name: "Well of Corruption", type: "Utility", effect: "ef-strip", label: "STRIP (Well)" },
            10625: { name: "Well of Suffering", type: "Utility", effect: "ef-strip", label: "DPS (Well)" },
            10833: { name: "Spectral Grasp", type: "Utility", effect: "ef-pull", label: "PULL (5x)" },
            41386: { name: "Sand Swell", type: "Utility", effect: "ef-stealth", label: "PORTAL" },
            10603: { name: "Corrosive Poison Cloud", type: "Utility", effect: "ef-reflect", label: "BLOCK PROJ" },

            // --- ELEMENTALIST ---
            56983: { name: "Wash the Pain Away!", type: "Utility", effect: "ef-cleanse", label: "CLEANSE" },
            5538: { name: "Mist Form", type: "Utility", effect: "ef-stealth", label: "MIST FORM" },
            5651: { name: "Lightning Flash", type: "Utility", effect: "ef-stealth", label: "BLINK" },
            
            // --- ENGINEER ---
            5837: { name: "Bomb Kit", type: "Utility", effect: "ef-blast", label: "BLAST SOURCE" },
            30357: { name: "Bulwark Gyro", type: "Utility", effect: "ef-reflect", label: "DOME" },
            30806: { name: "Sneak Gyro", type: "Utility", effect: "ef-stealth", label: "STEALTH GYRO" },
            5818: { name: "Elixir Gun", type: "Utility", effect: "ef-cleanse", label: "CLEANSE FIELD" },
            6020: { name: "Function Gyro", type: "Utility", effect: "ef-cleanse", label: "RES GYRO" },

            // --- MESMER ---
            10213: { name: "Veil", type: "Utility", effect: "ef-stealth", label: "VEIL" },
            30869: { name: "Gravity Well", type: "Utility", effect: "ef-pull", label: "GRAV WELL" },
            10201: { name: "Null Field", type: "Utility", effect: "ef-strip", label: "STRIP FIELD" },
            10236: { name: "Portal Entre", type: "Utility", effect: "ef-stealth", label: "PORTAL" },

            // --- REVENANT ---
            27326: { name: "Rite of the Great Dwarf", type: "Utility", effect: "ef-stab", label: "THE ROAD" },
            26685: { name: "Phase Traversal", type: "Utility", effect: "ef-blast", label: "CHASE" }
        };

        // --- WEAPON INFERENCE (Automatic Capabilities based on Class + Weapon) ---
        // ID: 9=Staff, 14=Scepter, 25=Focus, 24=Warhorn, 26=Hammer, 0=Sword
        const WEAPON_CAPABILITIES = {
            1: { // Guardian
                9: [{ label: "LINE WARDING", effect: "ef-pull" }, { label: "LIGHT FIELD", effect: "ef-cleanse" }],
                14: [{ label: "IMMOB", effect: "ef-pull" }], // Scepter
                26: [{ label: "BLAST", effect: "ef-blast" }] // Hammer
            },
            7: { // Elementalist
                9: [{ label: "WATER FIELDS", effect: "ef-water" }, { label: "BLAST", effect: "ef-blast" }, { label: "STATIC", effect: "ef-pull" }], // Staff
                24: [{ label: "WATER GLOBE", effect: "ef-water" }] // Warhorn
            },
            9: { // Necromancer
                9: [{ label: "FEAR MARK", effect: "ef-pull" }, { label: "REGEN MARK", effect: "ef-water" }] // Staff
            },
            4: { // Engineer
                 // Hammer (Scrapper) is ID 0 or Elite Spec specific, usually inferred by Spec
            }
        };

        const PROFESSION_NAMES = {
            1: "Guardian", 2: "Warrior", 3: "Engineer", 4: "Ranger", 5: "Thief", 
            6: "Elementalist", 7: "Mesmer", 8: "Necromancer", 9: "Revenant"
        };

        // --- CONFIG ---
        const firebaseConfig = {
            // PASTE YOUR KEYS HERE
            apiKey: "AIzaSyCp-Fg7QvdRmZ5I6mduyUYW7seuhdcdifc",
            authDomain: "wvw-commander.firebaseapp.com",
            projectId: "wvw-commander",
            storageBucket: "wvw-commander.firebasestorage.app",
            messagingSenderId: "1055181288368",
            appId: "1:1055181288368:web:20e9b9a17b0d7a70aa1c75"
        };

        // --- APP STATE ---
        let app, db, auth;
        let PALETTE_CACHE = {}; // Stores API results: { 'Guardian': { 12: 9081 }, ... }

        async function init() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if(user) {
                        setupLiveSync();
                        document.getElementById('connection-status').innerHTML = '<span class="text-green-400 font-bold">● ONLINE</span>';
                    }
                });
            } catch(e) {
                console.error(e);
                document.getElementById('connection-status').innerHTML = '<span class="text-red-500">CONFIG ERROR</span>';
            }
        }

        function setupLiveSync() {
            onSnapshot(query(collection(db, "wvw_v3_builds")), (snapshot) => {
                const builds = [];
                snapshot.forEach(doc => builds.push({ id: doc.id, ...doc.data() }));
                renderUI(builds);
            });
        }

        // --- API & DECODER ---
        async function getPaletteMap(professionName) {
            if (PALETTE_CACHE[professionName]) return PALETTE_CACHE[professionName];

            const statusEl = document.getElementById('api-status');
            statusEl.innerHTML = `<span class="loader"></span> Fetching ${professionName} data...`;
            statusEl.classList.remove('hidden');

            try {
                const res = await fetch(`https://api.guildwars2.com/v2/professions/${professionName}`);
                const data = await res.json();
                
                // Build Map: { PaletteID: SkillID }
                const map = {};
                // The API returns [ [paletteId, skillId], ... ] in data.skills_by_palette
                data.skills_by_palette.forEach(pair => {
                    map[pair[0]] = pair[1];
                });
                
                PALETTE_CACHE[professionName] = map;
                statusEl.classList.add('hidden');
                return map;
            } catch (e) {
                console.error("API Error", e);
                statusEl.textContent = "API Error";
                return null;
            }
        }

        async function parseBuildCode() {
            const code = document.getElementById('code-input').value.trim();
            const name = document.getElementById('name-input').value.trim() || "Unknown Agent";
            
            if (!code.startsWith('[&') || !code.endsWith(']')) {
                alert("Invalid Code Format"); return;
            }

            try {
                // 1. Base64 Decode
                const base64 = code.replace(/^\[&|\]$/g, '').replace(/-/g, '+').replace(/_/g, '/');
                const binaryString = window.atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
                const view = new DataView(bytes.buffer);

                // 2. Get Profession
                const profId = view.getUint8(1);
                const professionName = PROFESSION_NAMES[profId] || "Unknown";

                // 3. Fetch Palette Map for this Profession (The Magic Fix)
                const paletteMap = await getPaletteMap(professionName);
                if (!paletteMap) { alert("Could not fetch GW2 data. Check internet."); return; }

                // 4. Decode Utilities (Offsets 13, 15, 17, 19(Elite))
                const detectedAbilities = [];
                const utilityOffsets = [13, 15, 17, 19];
                
                utilityOffsets.forEach(offset => {
                    if(bytes.length >= offset + 2) {
                        const paletteId = view.getUint16(offset, true); // Little Endian
                        const skillId = paletteMap[paletteId]; // CONVERT PALETTE TO SKILL ID
                        
                        if (skillId && SKILL_META[skillId]) {
                            detectedAbilities.push(SKILL_META[skillId]);
                        }
                    }
                });

                // 5. Decode Weapons (Offsets 21, 22) & Infer Capabilities
                const weaponOffsets = [21, 22, 23, 24];
                weaponOffsets.forEach(offset => {
                    if(bytes.length > offset) {
                        const wId = view.getUint8(offset);
                        // Check specific weapon capabilities
                        if(WEAPON_CAPABILITIES[profId] && WEAPON_CAPABILITIES[profId][wId]) {
                            WEAPON_CAPABILITIES[profId][wId].forEach(cap => {
                                detectedAbilities.push({
                                    name: "Weapon Skill",
                                    label: cap.label,
                                    effect: cap.effect,
                                    type: "Weapon"
                                });
                            });
                        }
                    }
                });

                // 6. Save to DB
                await addDoc(collection(db, "wvw_v3_builds"), {
                    name: name,
                    profession: professionName,
                    abilities: detectedAbilities,
                    rawCode: code,
                    timestamp: serverTimestamp()
                });

                document.getElementById('code-input').value = '';
                
            } catch (e) {
                console.error(e);
                alert("Parsing failed. Code might be corrupted.");
            }
        }

        // --- RENDERERS ---
        function renderUI(builds) {
            // 1. Dashboard Tally
            const tally = {};
            builds.forEach(b => {
                if(b.abilities) {
                    b.abilities.forEach(a => {
                        if(!tally[a.label]) tally[a.label] = { count: 0, effect: a.effect, sources: [] };
                        tally[a.label].count++;
                        tally[a.label].sources.push(b.name); // Track who has it
                    });
                }
            });

            const grid = document.getElementById('capability-grid');
            grid.innerHTML = '';
            
            Object.keys(tally).sort((a,b) => tally[b].count - tally[a].count).forEach(key => {
                const item = tally[key];
                // Create tooltop list of names
                const sourceList = item.sources.join('\n');
                
                grid.innerHTML += `
                    <div class="bg-gray-800 border border-gray-700 p-3 rounded flex flex-col items-center justify-center shadow cursor-help" title="Sources:\n${sourceList}">
                        <div class="tag-base ${item.effect} mb-1 px-2 py-1 text-xs">${key}</div>
                        <div class="text-2xl font-bold text-white">${item.count}</div>
                    </div>
                `;
            });

            // 2. Detailed Roster
            const roster = document.getElementById('roster-list');
            roster.innerHTML = '';
            
            builds.forEach(b => {
                const abilitiesHtml = b.abilities.map(a => 
                    `<span class="tag-base ${a.effect} mr-1 mb-1 inline-block" title="${a.name}">${a.label}</span>`
                ).join('');

                roster.innerHTML += `
                    <div class="player-row flex items-start p-3 border-b border-gray-800">
                        <div class="w-32 shrink-0">
                            <div class="font-bold text-sm text-white truncate">${b.name}</div>
                            <div class="text-xs text-gray-500">${b.profession}</div>
                        </div>
                        <div class="flex-grow flex flex-wrap">
                            ${abilitiesHtml.length ? abilitiesHtml : '<span class="text-gray-600 text-xs italic">No key details tracked</span>'}
                        </div>
                        <button onclick="deleteItem('${b.id}')" class="text-gray-600 hover:text-red-500 ml-2">×</button>
                    </div>
                `;
            });

            document.getElementById('count-display').innerText = builds.length;
        }

        window.deleteItem = async (id) => {
            if(confirm("Delete this build?")) await deleteDoc(doc(db, "wvw_v3_builds", id));
        }

        window.processForm = (e) => {
            e.preventDefault();
            parseBuildCode();
        }

        init();
    </script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-4 space-y-4">
            <div class="bg-gray-800 p-5 rounded-lg border border-gray-700 shadow-lg">
                <h1 class="text-2xl font-bold text-white mb-1">COMMANDER INTEL <span class="text-green-500">V3</span></h1>
                <div class="flex justify-between text-xs text-gray-400 mb-4">
                    <span id="connection-status">Connecting...</span>
                    <span>SQUAD: <b id="count-display" class="text-white">0</b></span>
                </div>

                <form onsubmit="processForm(event)">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Player Name</label>
                    <input id="name-input" type="text" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white text-sm mb-3 focus:border-blue-500 outline-none" placeholder="Name">
                    
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Template Code</label>
                    <textarea id="code-input" rows="3" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-green-400 font-mono text-xs mb-3 focus:border-blue-500 outline-none" placeholder="[&...]"></textarea>
                    
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded transition shadow-lg">
                        DECODE & ADD
                    </button>
                    <div id="api-status" class="text-xs text-yellow-500 mt-2 hidden text-center"></div>
                </form>
            </div>

            <div class="bg-gray-900 p-4 rounded border border-gray-800 text-xs">
                <div class="font-bold text-gray-500 mb-2 uppercase">Legend</div>
                <div class="grid grid-cols-2 gap-2">
                    <div class="flex items-center"><span class="w-3 h-3 rounded mr-2 ef-stab"></span> Stability</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded mr-2 ef-water"></span> Water Field</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded mr-2 ef-blast"></span> Blast Finisher</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded mr-2 ef-strip"></span> Boon Strip</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded mr-2 ef-pull"></span> Pull / CC</div>
                    <div class="flex items-center"><span class="w-3 h-3 rounded mr-2 ef-reflect"></span> Reflect</div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-8 space-y-6">
            
            <div>
                <h2 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-2">Squad Capabilities</h2>
                <div id="capability-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3">
                    <div class="col-span-full text-center py-8 text-gray-600 border border-dashed border-gray-700 rounded">
                        No data. Add builds to see squad composition.
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 rounded-lg border border-gray-700 overflow-hidden">
                <div class="bg-gray-700 px-4 py-2 border-b border-gray-600 flex justify-between items-center">
                    <span class="font-bold text-gray-200 text-sm">ACTIVE ROSTER</span>
                    <span class="text-xs text-gray-400">Hover capabilities for details</span>
                </div>
                <div id="roster-list" class="max-h-[600px] overflow-y-auto">
                    </div>
            </div>

        </div>

    </div>
</body>
</html>
