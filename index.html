<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WvW Commander V12 (Instant Fix)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0b0d10; color: #cfd3d8; }
        
        /* TAGS */
        .tag { font-size: 0.65rem; font-weight: 800; padding: 3px 6px; border-radius: 3px; text-transform: uppercase; white-space: nowrap; margin: 1px; display: inline-block; cursor: help; }
        
        /* COLORS */
        .t-fire { background: #450a0a; color: #fca5a5; border: 1px solid #ef4444; }
        .t-water { background: #172554; color: #93c5fd; border: 1px solid #3b82f6; }
        .t-blast { background: #431407; color: #fdba74; border: 1px solid #f97316; }
        .t-stab { background: #083344; color: #67e8f9; border: 1px solid #06b6d4; box-shadow: 0 0 4px #06b6d4; } 
        .t-cleanse { background: #422006; color: #fde047; border: 1px solid #eab308; }
        .t-res { background: #14532d; color: #bef264; border: 1px solid #84cc16; }
        .t-reflect { background: #1e293b; color: #e2e8f0; border: 1px solid #94a3b8; }
        .t-block { background: #334155; color: #cbd5e1; border: 1px solid #64748b; }
        .t-might { background: #450a0a; color: #fda4af; border: 1px solid #f43f5e; }
        .t-strip { background: #3b0764; color: #d8b4fe; border: 1px solid #a855f7; }
        .t-pull { background: #500724; color: #f9a8d4; border: 1px solid #ec4899; }
        .t-cc { background: #881337; color: #fda4af; border: 1px solid #f43f5e; }
        .t-immob { background: #052e16; color: #86efac; border: 1px solid #22c55e; }
        .t-bubble { background: #713f12; color: #fef08a; border: 2px solid #facc15; animation: pulse 1.5s infinite; }
        .t-portal { background: #2e1065; color: #c4b5fd; border: 1px solid #8b5cf6; }
        .t-stealth { background: #1f2937; color: #d1d5db; border: 1px solid #4b5563; }
        .t-static { background: #4a044e; color: #f0abfc; border: 1px solid #d946ef; }
        .t-light { background: #422006; color: #fde047; border: 1px solid #eab308; }
        .t-ethereal { background: #3b0764; color: #e9d5ff; border: 1px solid #a855f7; }

        /* Active Filter State */
        .matrix-box:active { transform: scale(0.95); }
        .filter-active { border-color: #fff !important; background: #374151 !important; }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(250, 204, 21, 0); } 100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); } }
    </style>
</head>
<body class="p-4 max-w-screen-2xl mx-auto h-screen flex flex-col md:flex-row gap-4 overflow-hidden">

    <div class="w-full md:w-1/4 bg-gray-900 p-4 rounded flex flex-col gap-3 shadow-lg border border-gray-800">
        <h1 class="text-xl font-bold text-white">CMD INTEL <span class="text-blue-500">V12</span></h1>
        <div class="text-xs text-gray-500 flex justify-between"><span id="status">Initializing...</span></div>
        
        <div class="flex gap-2">
            <button onclick="app.loadDemo()" class="bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold p-2 rounded flex-1">LOAD DEMO</button>
            <button onclick="app.clearDB()" class="bg-red-900 hover:bg-red-700 text-white text-xs font-bold p-2 rounded">CLR</button>
        </div>

        <form onsubmit="app.addBuild(event)" class="flex flex-col gap-2">
            <input id="n" class="bg-gray-800 text-white p-2 rounded border border-gray-700 text-sm" placeholder="Name (e.g. Arc.1234)">
            <textarea id="c" class="bg-gray-800 text-green-400 p-2 rounded border border-gray-700 font-mono text-xs h-24 focus:border-blue-500 outline-none" placeholder="Paste Chat Code [&DQg...]"></textarea>
            <button class="bg-blue-700 hover:bg-blue-600 text-white font-bold p-2 rounded shadow transition">ADD BUILD</button>
        </form>
        
        <div class="flex-grow flex flex-col min-h-0">
            <div class="font-bold text-gray-400 uppercase text-xs mb-1">Status Log</div>
            <div id="debug-console" class="bg-black border border-gray-700 rounded p-2 text-[10px] font-mono overflow-y-auto flex-grow">
                <div class="text-gray-500">System Ready.</div>
            </div>
        </div>
    </div>

    <div class="w-full md:w-1/2 flex flex-col gap-2">
        <div class="bg-gray-900 p-2 rounded text-xs font-bold text-gray-400 text-center uppercase border border-gray-800 flex justify-between items-center">
            <span>Capabilities Matrix</span>
            <span class="text-[10px] text-gray-500 font-normal normal-case">Click capability to filter roster</span>
        </div>
        <div id="matrix" class="grid grid-cols-4 sm:grid-cols-5 lg:grid-cols-6 gap-2 overflow-y-auto p-1 content-start h-full bg-gray-900/50 rounded">
            <div class="col-span-full text-center text-gray-600 mt-10">Waiting for Data...</div>
        </div>
    </div>

    <div class="w-full md:w-1/4 bg-gray-900 flex flex-col border border-gray-800 rounded shadow-lg">
        <div class="p-3 border-b border-gray-800 flex justify-between items-center bg-gray-800">
            <span class="font-bold text-sm text-gray-300">Roster</span>
            <button onclick="app.resetFilter()" class="text-[10px] text-blue-400 hover:text-blue-300 hidden" id="reset-btn">RESET FILTER</button>
        </div>
        <div id="roster" class="overflow-y-auto flex-grow p-1">
            </div>
    </div>

    <script>
        // --- 1. FALLBACK DB (Offline/Safe Mode) ---
        const FALLBACK_PALETTES = {
            "Guardian": { 46: 9102, 53: 9081, 62: 9168, 59: 44946, 56: 44948, 15: 9081, 158: 44946, 14: 9036, 16: 9168, 20: 9251, 17: 9102, 28: 30273, 156: 44948, 33: 9251 },
            "Necromancer": { 16: 10615, 17: 10625, 134: 10833, 152: 41386, 15: 10603, 52: 29518, 3: 10556, 37: 10615, 38: 10625, 42: 10603, 121: 10833, 145: 41386 },
            "Warrior": { 148: 14419, 144: 14402, 143: 14401, 142: 14389, 13: 14515, 14: 14402, 15: 14401, 63: 14419, 20: 14515 },
            "Elementalist": { 158: 56983, 15: 5538, 18: 5651, 55: 5645, 160: 29969, 40: 5538, 43: 5651, 67: 5645 },
            "Mesmer": { 18: 10213, 20: 10236, 55: 30869, 16: 10201, 15: 10197, 13: 10311, 52: 29856, 30: 10213, 32: 10236, 34: 10201, 58: 30869 },
            "Engineer": { 140: 30357, 144: 30806, 138: 6020, 6: 5837, 5: 5818, 59: 31167, 0: 5936, 22: 5837, 21: 5818, 129: 30357 },
            "Thief": { 22: 13082, 20: 13066, 30: 13132, 21: 13022, 154: 56925 },
            "Ranger": { 23: 12569, 24: 12580, 32: 12523, 138: 30379, 143: 31914 },
            "Revenant": { 107: 27326, 104: 26685, 108: 27975 }
        };

        // --- 2. SKILL DEFINITIONS (Short Name + Tooltip Name) ---
        const SKILL_DB = {
            9081: { l: "STAB", n: "SYG", c: "t-stab" }, 44946: { l: "STAB", n: "Mantra", c: "t-stab" }, 9036: { l: "STAB", n: "Field", c: "t-stab" },
            9168: { l: "REFLECT", n: "Wall", c: "t-reflect" }, 9251: { l: "CC", n: "Sanctuary", c: "t-cc" }, 9102: { l: "FIRE", n: "Purging", c: "t-fire" },
            44948: { l: "MIGHT", n: "Potence", c: "t-might" }, 30273: { l: "PULL", n: "Dragons Maw", c: "t-pull" }, 45400: { l: "CLEANSE", n: "Ashes", c: "t-cleanse" },
            14419: { l: "BUBBLE", n: "Winds", c: "t-bubble" }, 14402: { l: "BLAST", n: "FGJ", c: "t-blast" }, 14401: { l: "CLEANSE", n: "Shake It", c: "t-cleanse" },
            14389: { l: "REZ", n: "Banner", c: "t-res" }, 14515: { l: "CC", n: "Bull's", c: "t-cc" },
            5837: { l: "BLAST", n: "Bomb Kit", c: "t-blast" }, 30357: { l: "REFLECT", n: "Bulwark", c: "t-reflect" }, 30806: { l: "STEALTH", n: "Sneak", c: "t-stealth" },
            6020: { l: "REZ", n: "Function", c: "t-res" }, 5818: { l: "CLEANSE", n: "Elixir Gun", c: "t-cleanse" }, 5821: { l: "SMOKE", n: "Flamethrower", c: "t-smoke" },
            31167: { l: "CC", n: "Supply Crate", c: "t-cc" }, 5936: { l: "WATER", n: "Mortar", c: "t-water" },
            12523: { l: "FIRE", n: "Bonfire", c: "t-fire" }, 12569: { l: "IMMOB", n: "Entangle", c: "t-immob" }, 12580: { l: "IMMOB", n: "Muddy", c: "t-immob" },
            30379: { l: "STAB", n: "Glyph", c: "t-stab" }, 31914: { l: "REZ", n: "Spirit", c: "t-res" },
            13082: { l: "STEALTH", n: "Refuge", c: "t-stealth" }, 13066: { l: "SMOKE", n: "Screen", c: "t-smoke" }, 13132: { l: "CC", n: "Basilisk", c: "t-cc" },
            13022: { l: "STATIC", n: "Seal/Pit", c: "t-static" }, 56925: { l: "IMMOB", n: "Needles", c: "t-immob" },
            56983: { l: "CLEANSE", n: "Wash Pain", c: "t-cleanse" }, 5538: { l: "STEALTH", n: "Mist Form", c: "t-stealth" }, 5651: { l: "STEALTH", n: "Flash", c: "t-stealth" },
            5516: { l: "STEALTH", n: "Vapor", c: "t-stealth" }, 5569: { l: "REZ", n: "Glyph", c: "t-res" }, 5645: { l: "CC", n: "Tornado", c: "t-cc" },
            29969: { l: "REZ", n: "Rebound", c: "t-res" },
            10213: { l: "STEALTH", n: "Veil", c: "t-stealth" }, 10236: { l: "PORTAL", n: "Entre", c: "t-portal" }, 30869: { l: "PULL", n: "Gravity", c: "t-pull" },
            10201: { l: "STRIP", n: "Null", c: "t-strip" }, 10197: { l: "REFLECT", n: "Feedback", c: "t-reflect" }, 10311: { l: "STEALTH", n: "Mass Invis", c: "t-stealth" },
            29856: { l: "STAB", n: "Precog", c: "t-stab" },
            10615: { l: "STRIP", n: "Well Corrupt", c: "t-strip" }, 10625: { l: "FIRE", n: "Well Suffer", c: "t-fire" }, 10833: { l: "PULL", n: "Grasp", c: "t-pull" },
            41386: { l: "PORTAL", n: "Sand Swell", c: "t-portal" }, 10603: { l: "REFLECT", n: "CPC", c: "t-reflect" }, 29518: { l: "STRIP", n: "Ghastly", c: "t-strip" },
            10556: { l: "CC", n: "Golem", c: "t-cc" },
            27326: { l: "STAB", n: "Roads", c: "t-stab" }, 27975: { l: "STAB", n: "Pain Absorb", c: "t-stab" }, 26685: { l: "BLAST", n: "Phase", c: "t-blast" }
        };

        const WEAPON_DB = {
            1: { 9: [{l:"CC", n:"Line", c:"t-cc"}, {l:"LIGHT", n:"Symbol", c:"t-light"}, {l:"BLAST", n:"Empower", c:"t-blast"}], 14: [{l:"IMMOB", n:"Scepter", c:"t-immob"}], 26: [{l:"CC", n:"Hammer", c:"t-cc"}, {l:"BLAST", n:"Hammer", c:"t-blast"}], 25: [{l:"BLAST", n:"Focus", c:"t-blast"}, {l:"LIGHT", n:"Focus", c:"t-light"}], 0: [{l:"PULL", n:"GS", c:"t-pull"}], 29: [{l:"CC", n:"Shield", c:"t-cc"}] },
            2: { 26: [{l:"CC", n:"Hammer", c:"t-cc"}, {l:"BLAST", n:"Hammer", c:"t-blast"}], 24: [{l:"CLEANSE", n:"Warhorn", c:"t-cleanse"}, {l:"BLAST", n:"Warhorn", c:"t-blast"}], 29: [{l:"BLOCK", n:"Shield", c:"t-block"}] },
            3: { 29: [{l:"BLAST", n:"Shield", c:"t-blast"}, {l:"REFLECT", n:"Shield", c:"t-reflect"}], 26: [{l:"BLAST", n:"Hammer", c:"t-blast"}, {l:"BLOCK", n:"Hammer", c:"t-block"}] },
            4: { 9: [{l:"WATER", n:"Staff", c:"t-water"}, {l:"BLAST", n:"Staff", c:"t-blast"}, {l:"REFLECT", n:"Wall", c:"t-reflect"}], 24: [{l:"BLAST", n:"Warhorn", c:"t-blast"}] },
            5: { 33: [{l:"BLAST", n:"Shortbow", c:"t-blast"}, {l:"DARK", n:"Poison", c:"t-dark"}], 22: [{l:"STEALTH", n:"Cloak", c:"t-stealth"}] },
            6: { 9: [{l:"WATER", n:"Staff", c:"t-water"}, {l:"FIRE", n:"Staff", c:"t-fire"}, {l:"STATIC", n:"Staff", c:"t-static"}, {l:"BLAST", n:"Staff", c:"t-blast"}], 24: [{l:"WATER", n:"Globe", c:"t-water"}], 25: [{l:"BLOCK", n:"Focus", c:"t-block"}], 34: [{l:"REFLECT", n:"Magnetic", c:"t-reflect"}] },
            7: { 25: [{l:"PULL", n:"Focus", c:"t-pull"}], 29: [{l:"BLOCK", n:"Shield", c:"t-block"}], 9: [{l:"ETHEREAL", n:"Staff", c:"t-ethereal"}] },
            8: { 9: [{l:"BLAST", n:"Staff", c:"t-blast"}, {l:"CC", n:"Fear", c:"t-cc"}, {l:"WATER", n:"Regen", c:"t-water"}], 24: [{l:"CC", n:"Warhorn", c:"t-cc"}], 25: [{l:"STRIP", n:"Focus", c:"t-strip"}] },
            9: { 26: [{l:"BLAST", n:"Hammer", c:"t-blast"}, {l:"CC", n:"Hammer", c:"t-cc"}], 9: [{l:"CLEANSE", n:"Staff", c:"t-cleanse"}, {l:"BLAST", n:"Staff", c:"t-blast"}] }
        };

        const PROFS = { 1:"Guardian", 2:"Warrior", 3:"Engineer", 4:"Ranger", 5:"Thief", 6:"Elementalist", 7:"Mesmer", 8:"Necromancer", 9:"Revenant" };

        // ============================
        // APP LOGIC
        // ============================
        const app = {
            db: null, auth: null, paletteCache: {}, activeFilter: null, localBuilds: [],
            
            log: function(msg, type) {
                const c = document.getElementById('debug-console');
                if(!c) return;
                const color = type === "error" ? "text-red-400" : (type === "success" ? "text-green-400" : (type === "warn" ? "text-yellow-400" : "text-gray-400"));
                c.innerHTML += `<div class="${color} border-b border-gray-800 pb-1 mb-1">${msg}</div>`;
                c.scrollTop = c.scrollHeight;
            },

            init: function() {
                this.log("Initializing...");
                const firebaseConfig = {
                    // PASTE KEYS HERE
                    apiKey: "AIzaSyCp-Fg7QvdRmZ5I6mduyUYW7seuhdcdifc",
                    authDomain: "wvw-commander.firebaseapp.com",
                    projectId: "wvw-commander",
                    storageBucket: "wvw-commander.firebasestorage.app",
                    messagingSenderId: "1055181288368",
                    appId: "1:1055181288368:web:20e9b9a17b0d7a70aa1c75"
                };

                try {
                    firebase.initializeApp(firebaseConfig);
                    this.db = firebase.firestore();
                    this.auth = firebase.auth();
                    
                    this.auth.signInAnonymously().catch(e => this.log("Auth Error: " + e.message, "error"));
                    this.auth.onAuthStateChanged(u => {
                        if(u) {
                            this.log("Firebase Connected!", "success");
                            document.getElementById('status').innerHTML = '<span class="text-green-400">● Online</span>';
                            this.setupSync();
                        }
                    });
                } catch(e) { this.log("CONFIG ERROR.", "error"); }
            },

            setupSync: function() {
                this.db.collection("wvw_v12_builds").orderBy("timestamp", "desc").onSnapshot(snap => {
                    const builds = [];
                    snap.forEach(d => builds.push({ id: d.id, ...d.data() }));
                    this.localBuilds = builds; // Cache locally for filtering
                    this.renderMatrix(builds);
                    this.renderRoster(builds);
                });
            },

            // --- ROBUST API FETCH WITH TIMEOUT ---
            getPalette: async function(prof) {
                if(this.paletteCache[prof]) return this.paletteCache[prof];
                this.log(`Fetching API for ${prof}...`);
                
                // 0.5 Second Timeout: If API is slow, FAIL IMMEDIATELY to prevent hanging
                const timeoutPromise = new Promise((_, reject) => setTimeout(() => reject(new Error("Timeout")), 500));
                
                try {
                    const response = await Promise.race([
                        fetch(`https://api.guildwars2.com/v2/professions/${prof}`),
                        timeoutPromise
                    ]);
                    
                    const d = await response.json();
                    const map = {};
                    if (d.skills_by_palette) d.skills_by_palette.forEach(p => map[p[0]] = p[1]);
                    this.paletteCache[prof] = map;
                    this.log("API Success", "success");
                    return map;
                } catch(e) {
                    this.log(`API Fail/Slow (${e.message}). Using Fallback.`, "warn");
                    return FALLBACK_PALETTES[prof] || null;
                }
            },

            addBuild: async function(e) {
                e.preventDefault();
                const code = document.getElementById('c').value.trim();
                const name = document.getElementById('n').value.trim() || "Agent";
                if(!code.startsWith('[&')) return this.log("Invalid Code", "error");

                try {
                    const b64 = code.replace(/^\[&|\]$/g, '').replace(/-/g, '+').replace(/_/g, '/');
                    const bin = window.atob(b64);
                    const bytes = new Uint8Array(bin.length);
                    for(let i=0; i<bin.length; i++) bytes[i] = bin.charCodeAt(i);
                    const v = new DataView(bytes.buffer);

                    const profId = v.getUint8(1);
                    const profName = PROFS[profId];
                    this.log(`Decoding ${profName}...`);

                    const map = await this.getPalette(profName); // Will use Fallback instantly if API hangs
                    const skills = [];

                    if(map) {
                        const offsets = [11, 13, 15, 17];
                        offsets.forEach(o => {
                            if(bytes.length >= o+2) {
                                const pid = v.getUint16(o, true);
                                if (pid > 5000) return;
                                const sid = map[pid];
                                if(SKILL_DB[sid]) skills.push(SKILL_DB[sid]);
                            }
                        });
                    }

                    [21,22,23,24].forEach(o => {
                        if(bytes.length > o) {
                            const wid = v.getUint8(o);
                            if(wid !== 0 && WEAPON_DB[profId] && WEAPON_DB[profId][wid]) {
                                WEAPON_DB[profId][wid].forEach(s => skills.push(s));
                            }
                        }
                    });

                    await this.db.collection("wvw_v12_builds").add({
                        name, prof: profName, skills, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    document.getElementById('c').value = "";
                    this.log("Build Added.", "success");
                } catch(err) { this.log("Error: " + err.message, "error"); }
            },

            del: async function(id) { await this.db.collection("wvw_v12_builds").doc(id).delete(); },
            loadDemo: async function() {
                await this.db.collection("wvw_v12_builds").add({
                    name: "Demo Guard", prof: "Guardian", skills: [SKILL_DB[9081], SKILL_DB[9102]], timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
            },
            clearDB: async function() {
                const snap = await this.db.collection("wvw_v12_builds").get();
                snap.forEach(d => d.ref.delete());
            },

            // --- FILTER LOGIC ---
            setFilter: function(label) {
                this.activeFilter = label;
                document.getElementById('reset-btn').classList.remove('hidden');
                this.renderRoster(this.localBuilds);
                // Visual highlight in matrix
                document.querySelectorAll('.matrix-box').forEach(el => el.classList.remove('filter-active'));
                document.getElementById(`box-${label}`).classList.add('filter-active');
            },
            resetFilter: function() {
                this.activeFilter = null;
                document.getElementById('reset-btn').classList.add('hidden');
                document.querySelectorAll('.matrix-box').forEach(el => el.classList.remove('filter-active'));
                this.renderRoster(this.localBuilds);
            },

            renderMatrix: function(builds) {
                const tally = {};
                builds.forEach(b => {
                    if(b.skills) b.skills.forEach(s => {
                        if(!tally[s.l]) tally[s.l] = { count: 0, c: s.c };
                        tally[s.l].count++;
                    });
                });
                
                const grid = document.getElementById('matrix');
                grid.innerHTML = "";
                Object.keys(tally).sort((a,b) => tally[b].count - tally[a].count).forEach(k => {
                    const t = tally[k];
                    // CLICK to Filter
                    grid.innerHTML += `
                    <div id="box-${k}" onclick="app.setFilter('${k}')" class="matrix-box bg-gray-800 border border-gray-700 p-2 rounded flex flex-col items-center cursor-pointer select-none hover:bg-gray-700 transition">
                        <div class="tag ${t.c} mb-1 pointer-events-none">${k}</div>
                        <div class="text-xl font-bold text-white pointer-events-none">${t.count}</div>
                    </div>`;
                });
            },

            renderRoster: function(builds) {
                const list = document.getElementById('roster');
                list.innerHTML = "";
                
                // Filter logic
                const displayBuilds = this.activeFilter 
                    ? builds.filter(b => b.skills && b.skills.some(s => s.l === this.activeFilter))
                    : builds;

                if(displayBuilds.length === 0) {
                    list.innerHTML = '<div class="text-center text-gray-600 text-xs mt-4">No builds match filter.</div>';
                    return;
                }

                displayBuilds.forEach(b => {
                    // Detailed Tags: STAB (SYG)
                    const tags = b.skills ? b.skills.map(s => {
                        // Highlight specific tag if filtering
                        const opacity = (this.activeFilter && s.l !== this.activeFilter) ? 'opacity-20' : 'opacity-100';
                        return `<span class="tag ${s.c} ${opacity}" title="${s.n}">${s.l} (${s.n})</span>`;
                    }).join('') : '';

                    list.innerHTML += `
                    <div class="flex flex-col p-2 border-b border-gray-800 hover:bg-gray-800 transition">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-xs text-white truncate w-24">${b.name}</span>
                            <span class="text-[10px] text-gray-500">${b.prof}</span>
                            <button onclick="app.del('${b.id}')" class="text-gray-600 hover:text-red-500 font-bold px-2">×</button>
                        </div>
                        <div class="flex flex-wrap gap-1">${tags}</div>
                    </div>`;
                });
            }
        };

        app.init();
    </script>
</body>
</html>
